---
# task install

- name: disable selinux
  selinux:
    state: disabled

- name: install dependencies
  yum:
    name: "{{ item }}"
    state: present
  with_items:
    - docker
    - docker-python
    - git

- name: configure docker service
  service:
    name: docker
    enabled: yes
    state: started

- name: clone eyesofindicator git project
  git:
    repo: "{{ eoi_repo }}"
    dest: "{{ eoi_repo_dir }}"
    version: "{{ eoi_version }}"
    update: "{{ eoi_keep_updated }}"
    force: yes
    accept_hostkey: yes

- name: build docker image
  docker_image:
    path: "{{ eoi_repo_dir }}"
    name: "{{ eoi_image }}"
    tag: "{{ eoi_version }}"

- name: create required directories
  file:
    path: "{{ item }}"
    mode: 0755
    state: directory
    owner: root
    group: root
  with_items:
    - "/srv/eyesofindicator"
    - "/srv/eyesofindicator/{{ eoi_container }}"
    - "/srv/eyesofindicator/{{ eoi_container }}/assets"
    - "/srv/eyesofindicator/{{ eoi_container }}/dashboards"
    - "/srv/eyesofindicator/{{ eoi_container }}/config"
    - "/srv/eyesofindicator/{{ eoi_container }}/jobs"
    - "/srv/eyesofindicator/{{ eoi_container }}/lib-eoi"
    - "/srv/eyesofindicator/{{ eoi_container }}/widgets"
    - "/srv/eyesofindicator/{{ eoi_container }}/public"

- name: run docker container
  docker_container:
    name: "{{ eoi_container }}"
    image: "{{ eoi_image }}:{{ eoi_version }}"
    state: started
    restart_policy: always
    ports:
    - "{{ eoi_port }}:3030"
    env:
      APKS: "{{ eoi_apks }}"
      GEMS: "{{ eoi_gems }}"
      WIDGETS: "{{ eoi_widgets }}"
    volume: "{{ item }}"
  with_items:
    - "/srv/eyesofindicator/{{ eoi_container }}/assets:/assets"
    - "/srv/eyesofindicator/{{ eoi_container }}/dashboards:/dashboards"
    - "/srv/eyesofindicator/{{ eoi_container }}/config:/config"
    - "/srv/eyesofindicator/{{ eoi_container }}/jobs:/jobs"
    - "/srv/eyesofindicator/{{ eoi_container }}/lib-eoi:/lib-eoi"
    - "/srv/eyesofindicator/{{ eoi_container }}/widgets:/widgets"
    - "/srv/eyesofindicator/{{ eoi_container }}/public:/public"
